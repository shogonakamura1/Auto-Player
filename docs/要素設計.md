# 音楽再生アプリ 要素設計書

## 1. 概要
**開発経緯**: ダンサーが練習中にスマホを持ったまま踊ることが困難で、音楽再生のためにスマホの場所まで移動して操作し、また元の位置に戻って踊り始めるという無駄な作業を簡略化するため

**目的**: 音声操作により、ダンサーが練習位置から動かずに音楽を制御できるWebアプリケーション（Django + Bootstrap）

**目玉機能**: 音声操作による音楽再生制御（ダンサー向け専門機能）

## 2. 主要機能要素

### 2.1 音声操作機能（最優先機能）
- **基本音声操作**
  - 「再生」「一時停止」「停止」の音声コマンド
  - 「音量上げて」「音量下げて」の音声コマンド

- **ダンサー練習効率化機能**
  - 「そこもう一回します」：前回の再生開始位置からの再生（練習の繰り返し）
  - 「○エイト前からします」：エイト単位での再生位置指定（特定部分の練習）
  - 「カウント1から」：曲の最初から再生（振り付けの最初から）
  - 「サビから」：サビ部分から再生（特定セクション練習）
  - 「Aメロから」：Aメロ部分から再生（特定セクション練習）
  - 「1分30秒のところから」：時間指定での再生位置指定（精密な練習）
  - 「ビートを教えて」：現在のBPMとカウントを音声案内（練習中の確認）
  - 「テンポ上げて」「テンポ下げて」：再生速度調整（練習レベル調整）

- **練習支援機能**
  - 「ループ」：特定部分の繰り返し再生
  - 「スロー」：ゆっくり再生（振り付け確認）
  - 「カウント入り」：カウント音声付き再生
  - 「カウント無し」：カウント音声なし再生

- **音声フィードバック**
  - 操作確認の音声応答（「カウント1から再生します」）
  - 曲情報の音声読み上げ
  - エラー時の音声案内
  - 音量調整時の音声確認
  - カウント情報の音声案内
  - 時間情報の音声案内（「1分30秒のところから再生します」）

- **デバイス分離機能**
  - イヤホン：音声認識入力・音声フィードバック
  - スピーカー/イヤホン：音楽再生出力
  - 音声認識と音楽再生の分離制御

### 2.2 カウント機能（練習効率化の核心）
- **自動BPM検出によるカウント測定**
  - エイト（8拍）単位での時間計算
  - 音楽の構造（イントロ、Aメロ、サビ等）の自動検出
  - カウント音声案内（「1, 2, 3, 4, 5, 6, 7, 8」）

### 2.3 音楽再生機能
- **音楽ファイル再生**
  - 複数フォーマット対応（MP3, WAV, FLAC, AAC等）
  - 再生・一時停止・停止
  - 音量調整
  - 再生速度調整（0.5倍〜2.0倍）
  - シーク機能（再生位置の移動）

- **時間表示機能**
  - 再生中の大きな秒数表示（画面中央）
  - 現在時間 / 総時間の表示
  - 分:秒形式での表示（例：1:30 / 3:45）
  - 時間指定での再生位置移動

### 2.4 音楽管理機能
- **ファイル選択機能**
  - 音楽ファイルのアップロード
  - ファイル名の表示
  - 再生時間の表示
  - ファイルサイズの表示
  - ファイル選択画面での音楽ファイル一覧表示

### 2.5 ユーザーインターフェース
- **メイン画面（練習中に使用）**
  - 再生コントロール（再生/一時停止、停止）
  - プログレスバー
  - 音量スライダー
  - 現在再生中の曲情報表示
  - 音声操作状態表示
  - カウント表示
  - **大きな秒数表示（画面中央）**
    - 現在の再生時間を大きく表示
    - 分:秒形式（例：1:30）
    - 視認性の高いフォントサイズ
    - ダークモード対応

- **ファイル選択画面**
  - 音楽ファイル一覧表示
  - ファイル検索機能
  - ファイル情報表示（サイズ、再生時間）
  - ファイル選択ボタン

- **ライブラリ画面**
  - 曲一覧表示
  - 検索機能
  - アルバムアート表示

### 2.6 設定機能
- **アプリケーション設定**
  - テーマ設定（ダーク/ライトモード）
  - 言語設定
  - 自動再生設定

- **音声設定**
  - 出力デバイス選択
  - イコライザー設定
  - 音声認識言語設定
  - 音声フィードバック設定
  - カウント音声設定

- **練習設定**
  - デフォルト再生速度設定
  - カウント音声の有無設定

## 3. 技術要素

### 3.1 バックエンド（Django）
- **Webフレームワーク**
  - Django 4.2.7
  - MVT（Model-View-Template）アーキテクチャ
  - Django REST Framework（API用）

- **データベース**
  - SQLite（開発環境）
  - PostgreSQL（本番環境）

- **音楽処理**
  - pydub（音声ファイル処理）
  - mutagen（メタデータ読み取り）

### 3.2 フロントエンド
- **HTML/CSS**
  - Bootstrap 5.3.0（レスポンシブデザイン）
  - カスタムCSS（スマホ特化スタイル）

- **JavaScript**
  - Web Audio API（音楽再生・音声処理）
  - Web Speech API（音声認識・音声合成）
  - MediaSession API（ロック画面コントロール）
  - Fetch API（API通信）
  - AudioContext（音声デバイス分離）

### 3.3 音声処理技術
- **音声認識（Speech Recognition）**
  - Web Speech API SpeechRecognition
  - 日本語音声認識対応
  - ノイズ除去・音声フィルタリング
  - ダンサー用語の音声認識最適化

- **音声デバイス制御**
  - getUserMedia API（マイク入力）
  - AudioContext（音声出力制御）
  - デバイス選択・切り替え機能

### 3.4 音楽分析技術
- **BPM検出・カウント機能**
  - librosa（Python音声分析ライブラリ）
  - 自動BPM検出
  - エイト（8拍）単位での時間計算
  - ビート位置の正確な検出

- **音楽構造分析**
  - イントロ、Aメロ、サビ等の自動検出
  - セクション別の時間情報管理
  - 音楽の特徴点（ドロップ、ビルドアップ等）の検出

- **リアルタイムカウント**
  - 現在の再生位置に基づくカウント計算
  - エイト単位での位置指定機能
  - カウント音声の同期出力

### 3.5 ファイル管理
- **静的ファイル**
  - Django static files
  - 音楽ファイルの保存
  - アプリアイコン

- **メディアファイル**
  - アップロードされた音楽ファイル
  - ユーザーアップロード管理

## 4. データベース設計

### 4.1 主要モデル
- **MusicFile**: 音楽ファイル情報
- **User**: ユーザー情報（Django標準）
- **VoiceCommand**: 音声コマンド設定
- **MusicAnalysis**: 音楽分析情報

### 4.2 モデル詳細
```python
# MusicFile
- title: 曲のタイトル
- file: 音楽ファイル
- duration: 再生時間（秒）
- file_size: ファイルサイズ（バイト）
- uploaded_at: アップロード日時

# VoiceCommand
- command: 音声コマンド
- action: 実行するアクション
- user: ユーザー
- is_active: 有効/無効

# MusicAnalysis
- music_file: 音楽ファイル（ForeignKey）
- bpm: BPM値
- beat_times: ビート位置の配列
- sections: 音楽構造情報（JSON）
- last_play_position: 前回の再生開始位置
- analysis_updated_at: 分析更新日時
```

## 5. 非機能要件

### 5.1 パフォーマンス
- 大容量ライブラリでの高速動作
- 低遅延での音楽再生
- 音声認識のリアルタイム処理
- バッテリー消費の最適化（PWA対応）

### 5.2 ユーザビリティ
- 直感的なタッチ操作
- 片手操作対応
- 音声操作の自然な体験
- アクセシビリティ対応

### 5.3 互換性
- モダンブラウザ対応（Chrome, Safari, Firefox）
- 様々な音声ファイル形式対応
- 異なる音声デバイス対応（イヤホン、スピーカー等）
- 音声認識API対応ブラウザ

### 5.4 音声品質
- 音声認識の高精度化
- ノイズ除去機能
- 音声フィードバックの自然さ
- 音楽再生と音声認識の分離品質

## 6. 開発・デプロイ環境

### 6.1 開発環境
- **Python 3.11+**
- **Django 4.2.7**
- **Bootstrap 5.3.0**
- **SQLite**（開発用データベース）

### 6.2 デプロイ環境
- **Webホスティングサービス**
  - Heroku
  - Railway
  - Render
  - PythonAnywhere

### 6.3 依存関係
```txt
Django==4.2.7
django-crispy-forms==2.1
crispy-bootstrap5==0.7
Pillow==10.1.0
python-dotenv==1.0.0
pydub==0.25.1
mutagen==1.47.0
librosa==0.10.1
numpy==1.24.3
scipy==1.11.1
```

## 7. 将来拡張予定機能
- **ストリーミングサービス連携**
- **音声認識による曲検索**
- **AIによるプレイリスト自動生成**
- **デスクトップアプリ連携**
- **ソーシャル機能（プレイリスト共有等）**
- **音声感情認識による音楽選択**
- **多言語音声操作対応**
- **自然言語処理による音声操作拡張**
  - 様々な言い回しの指示に対応
  - 「もう一回」「リピート」「繰り返し」等の同義語対応
  - 「少し前から」「ちょっと戻って」等の曖昧な指示対応
  - 文脈を理解した音声操作
  - 学習機能による個人の言い回しへの対応 